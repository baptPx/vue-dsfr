<script>
import { defineComponent } from 'vue'

// Pose problème dans les tests, et risque fort de poser problème dans Nuxt
// import '@gouvfr/dsfr/dist/component/header/header.module.js'

import DsfrLogo from '../DsfrLogo/DsfrLogo.vue'
import DsfrSearchBar from '../DsfrSearchBar/DsfrSearchBar.vue'
import DsfrHeaderMenuLinks from './DsfrHeaderMenuLinks.vue'
import DsfrNavigation from '../DsfrNavigation/DsfrNavigation.vue'

export default defineComponent({
  name: 'DsfrHeader',

  components: {
    DsfrLogo,
    DsfrHeaderMenuLinks,
    DsfrSearchBar,
    DsfrNavigation
  },

  props: {
    serviceTitle: {
      type: String,
      default: undefined,
    },
    serviceDescription: {
      type: String,
      default: undefined,
    },
    homeTo: {
      type: String,
      default: '/',
    },
    logoText: {
      type: [String, Array],
      default: () => 'Gouvernement',
    },
    modelValue: {
      type: String,
      default: '',
    },
    operatorImgAlt: {
      type: String,
      default: '',
    },
    operatorImgSrc: {
      type: String,
      default: undefined,
    },
    operatorImgStyle: {
      type: Object,
      default: () => undefined,
    },
    placeholder: {
      type: String,
      default: 'Rechercher',
    },
    quickLinks: {
      type: Array,
      default: () => undefined,
    },
    searchLabel: {
      type: String,
      default: 'Recherche',
    },
    quickLinksAriaLabel: {
      type: String,
      default: 'Menu secondaire',
    },
    navItems:{
      type: Array,
      default: () => [],
    },
    showSearch: Boolean,
  },

  emits: ['update:modelValue', 'search'],

  data () {
    return {
      menuOpened: false,
      searchModalOpened: false,
      modalOpened: false,
    }
  },

  computed: {
    isWithSlotOperator () {
      return this.$slots.operator?.().length || !!this.operatorImgSrc
    },
  },

  mounted () {
    document.addEventListener('keydown', this.onKeyDown)
  },
  unmounted () {
    document.removeEventListener('keydown', this.onKeyDown)
  },
  methods: {
    hideModal () {
      this.modalOpened = false
      this.menuOpened = false
      this.searchModalOpened = false
      document.getElementById('button-menu')?.focus()
    },
    showMenu () {
      this.modalOpened = true
      this.menuOpened = true
      this.searchModalOpened = false
      document.getElementById('close-button')?.focus()
    },
    showSearchModal () {
      this.modalOpened = true
      this.menuOpened = false
      this.searchModalOpened = true
    },
    onKeyDown (e) {
      if (e.key === 'Escape') {
        this.hideModal()
      }
    },
    onQuickLinkClick () {
      this.hideModal()
    },
  },
})
</script>

<template>
  <header
    role="banner"
    class="fr-header"
  >
      <!-- <hr 
        v-if="navItems.length > 0"
        class="navItemsBar"
        > -->
    <div class="fr-header__body">
      <div class="fr-container  width-inherit">
        <div class="fr-header__body-row">
          <div class="fr-header__brand  fr-enlarge-link">
            <div class="fr-header__brand-top">
              <div class="fr-header__logo">
                <DsfrLogo
                  :logo-text="logoText"
                  data-testid="header-logo"
                />
              </div>
              <div
                v-if="isWithSlotOperator"
                class="fr-header__operator"
              >
                <!-- @slot Slot nommé operator pour le logo opérateur. Sera dans `<div class="fr-header__operator">` -->
                <slot name="operator">
                  <img
                    v-if="operatorImgSrc"
                    class="fr-responsive-img"
                    :src="operatorImgSrc"
                    :alt="operatorImgAlt"
                    :style="operatorImgStyle"
                  >
                </slot>
              </div>
              <div
                v-if="showSearch || quickLinks?.length"
                class="fr-header__navbar"
              >
                <button
                  v-if="showSearch"
                  class="fr-btn  fr-btn--search"
                  aria-controls="header-search"
                  aria-label="Recherche"
                  title="Recherche"
                  :data-fr-opened="showSearchModal"
                  @click="showSearchModal"
                />
                <button
                  v-if="quickLinks?.length"
                  id="button-menu"
                  class="fr-btn--menu  fr-btn"
                  :data-fr-opened="showMenu"
                  aria-controls="header-navigation"
                  aria-haspopup="menu"
                  aria-label="Menu"
                  title="Menu"
                  data-testid="open-menu-btn"
                  @click="showMenu()"
                />
              </div>
            </div>
            <div
              v-if="serviceTitle"
              class="fr-header__service"
            >
              <RouterLink
                :to="homeTo"
                :title="`Accueil - ${serviceTitle}`"
                v-bind="$attrs"
              >
                <p class="fr-header__service-title">
                  {{ serviceTitle }}
                </p>
              </RouterLink>
              <p
                v-if="serviceDescription"
                class="fr-header__service-tagline"
              >
                {{ serviceDescription }}
              </p>
            </div>
          </div>
          <div class="fr-header__tools">
            <div
              v-if="quickLinks && quickLinks.length"
              class="fr-header__tools-links"
            >
              <nav role="navigation">
                <DsfrHeaderMenuLinks
                  v-if="!menuOpened"
                  :links="quickLinks"
                  :nav-aria-label="quickLinksAriaLabel"
                />
              </nav>
            </div>
            <div
              v-if="showSearch"
              class="fr-header__search  fr-modal"
            >
              <DsfrSearchBar
                :label="searchLabel"
                :model-value="modelValue"
                :placeholder="placeholder"
                style="justify-content: flex-end"
                @update:model-value="$emit('update:modelValue', $event)"
                @search="$emit('search', $event)"
              />
            </div>
          </div>
        </div>
        <div
          v-if="showSearch || (quickLinks && quickLinks.length)"
          id="header-navigation"
          class="fr-header__menu  fr-modal"
          :class="{ 'fr-modal--opened': modalOpened }"
          aria-label="Menu modal"
          role="dialog"
          aria-modal="true"
        >
          <div class="fr-container">
            <button
              id="close-button"
              class="fr-btn fr-btn--close"
              aria-controls="header-navigation"
              data-testid="close-modal-btn"
              @click="hideModal"
            >
              Fermer
            </button>
            <div class="fr-header__menu-links">
              <nav role="navigation">
                <DsfrHeaderMenuLinks
                  v-if="menuOpened"
                  role="navigation"
                  :links="quickLinks"
                  :nav-aria-label="quickLinksAriaLabel"
                  @link-click="onQuickLinkClick"
                />
                <DsfrNavigation
                  :nav-items="navItems"
                  @link-click="onQuickLinkClick"
                />
              </nav>
            </div>
            <div
              v-if="searchModalOpened"
              class="flex  justify-center  items-center"
            >
              <DsfrSearchBar
                :model-value="modelValue"
                :placeholder="placeholder"
                @update:model-value="$emit('update:modelValue', $event)"
                @search="$emit('search', $event)"
              />
            </div>
          </div>
        </div>
        <slot />
  
      </div>
    </div>
  </header>
  <div class="desktop-navigation">
    <div class="desktop-navigation-content">

      <DsfrNavigation
        :nav-items="navItems"
      />
    </div>
  </div>
</template>

<style src="@gouvfr/dsfr/dist/component/header/header.main.min.css" />
<style scoped>

@media (max-width: 62em) {
  .desktop-navigation {
    display:none;
  }
  .navItemsBar {
    display: none;
  }
}

@media (min-width: 62em) {
  .navItemsBar {
    
    width: 100%;
    border-bottom: 1px solid #E5E5E5;
    position: absolute;
    bottom: 3.5rem;
  }
  .desktop-navigation {
    position: sticky;
    top: 0;
    filter: drop-shadow(0 1px 3px rgba(0,0,18,.16));
    background: #fff;
    padding-left: 1rem;
    z-index: 10;
  }
  .desktop-navigation-content {
    max-width: 78rem;
    margin-left: auto;
    margin-right: auto;
  }
  .fr-header {
    /* box-shadow: inset 0 1px 0 0 var(--border-default-grey); */
    filter: none;
    border-bottom: 1px solid #E5E5E5 ;
  }
}
@media (min-width: 78rem) {
  .desktop-navigation {
    padding-left: 3rem;

  }
}
</style>
